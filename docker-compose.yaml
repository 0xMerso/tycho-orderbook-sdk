networks:
  tycho:
    external: true

services:
  redis:
    image: redis:latest
    restart: always
    ports:
      - "7777:7777"
    environment:
      - BUILD_TYPE=debug
      - REDIS_HOST=redis
      - REDIS_PORT=7777
      - REDIS_ARGS="--loglevel verbose"
    healthcheck:
      test: ["CMD-SHELL", "redis-cli ping | grep PONG"]
      interval: 1s
      timeout: 3s
      retries: 5
    networks:
      - tycho

  ethereum:
    build: 
      context: back
      dockerfile: ops/Dockerfile
      args:
        - PROGRAM=stream
    ports:
      - "42001:42001"
    volumes:
      - ./back:/app
    command: cargo watch -w /app -x "run --bin stream"
    depends_on:
      redis:
        condition: service_healthy
    environment:
      - BUILD_TYPE=debug
      - REDIS_HOST=redis
      - NETWORK=ethereum
      - TESTING=true
      - TYCHO_URL=https://tycho-beta.propellerheads.xyz
      - TYCHO_API_KEY=sampletoken
      - HEARTBEAT=ToDo
    restart: always
    networks:
      - tycho

  web:
    build:
      context: front
      dockerfile: ops/Dockerfile  # Uses the Dockerfile from front/ops
    ports:
      - "41777:3000"  # Expose container's port 3000 on host port 41777
    volumes:
      - ./front:/app
    environment:
      - NEXT_PUBLIC_STREAM_API_URL=http://ethereum:42001
      - NEXT_PUBLIC_ORDERBOOK_ENDPOINT=/orderbook?tag=0xa0b86991c6218b36c1d19d4a2e9eb0ce3606eb48-0xc02aaa39b223fe8d0a0e5c4f27ead9083c756cc2&z0to1=false
    depends_on:
      - ethereum
    restart: always
    networks:
      - tycho
  
  # base:
  # arbitrum:
  # starknet:

